function getMaxOfArray(e){return Math.max.apply(null,e)}function saveState(e,t){localStorage.getItem(t)&&(e.value=localStorage.getItem(t)),e.addEventListener("blur",function(){localStorage.setItem(t,e.value)})}function startProcess(){download.setAttribute("class","button alert"),download.setAttribute("href","#"),download.removeAttribute("disabled"),download.innerHTML='<i class="fi-x-circle"></i> Download is not ready yet',document.querySelector("#charts").classList.remove("done"),process()}function makeTextFile(e){var t=new Blob([e],{type:"text/plain"});null!==o&&window.URL.revokeObjectURL(o);var o=window.URL.createObjectURL(t);return o}function process(){var e=inputtext.value,t=everything.value.split("\n\n"),o=clusters.value.split("\n");if(""==clusters.value)return void console.log("No Clusters!");""==e&&""==t||o.length<1||(updateBlocks(),uselocalmess.checked?""!=e&&bgWorker.postMessage(["processlocal",e.trim(),o]):t.length>0&&""!=t&&bgWorker.postMessage(["processblocks",everything.value,o]))}function buildCharts(e){if(e){var t=e[0],o=e[1];document.querySelector("#canvas").innerHTML='<canvas id="overview" height="400"></canvas>';var a=document.querySelector("#overview").getContext("2d"),l=new Chart(a,{type:"horizontalBar",data:{labels:o,datasets:[{label:"Clusters distribution",data:t,backgroundColor:"rgba(255, 99, 132, 0.2)",borderColor:"rgba(255,99,132,1)",borderWidth:1}]},options:{responsive:!0,animation:{onComplete:function(e){var t=this.chart,o=t.ctx;o.textAlign="center",Chart.helpers.each(this.data.datasets.forEach(function(e,a){var l=t.controller.getDatasetMeta(a);Chart.helpers.each(l.data.forEach(function(t,a){var l=15;e.data[a]>100&&(l=20),o.fillText(e.data[a],t._model.x+l,t._model.y-7)}),this)}),this),document.querySelector("#savegraph").setAttribute("href",document.querySelector("#overview").toDataURL())}}}})}}function updateBlocks(){document.querySelector("#blocks").classList.remove("done");var e=everything.value.split("\n\n");if(e.length>0&&""!=e){var t="";tempblocks=[];for(var o=0;o<e.length;o++){var a=/^(.*)$/m,l=e[o].trim().match(a);tempblocks.push(l[0])}var r=tempblocks.join("|");if(""==blocklinks.getAttribute("data-hash")||blocklinks.getAttribute("data-hash")!=r){blocklinks.setAttribute("data-hash",r);for(var o=0;o<tempblocks.length;o++)t+='<div><input type="checkbox" class="custom-block" id="block'+o+'" data-key="'+o+'" /> <label for="block'+o+'" data-key="'+o+'">'+tempblocks[o]+"</label></div>";blocklinks.innerHTML=t}for(var n=document.querySelectorAll(".custom-block"),s=document.querySelectorAll(".custom-block:checked"),o=0;o<n.length;o++)n[o].addEventListener("change",function(t){var o=document.querySelectorAll(".custom-block:checked");if(o){inputtext.value="";for(var a=0;a<o.length;a++)inputtext.value+=e[o[a].getAttribute("data-key")],localStorage.setItem("input",inputtext.value)}});document.querySelector("#blocks").classList.add("done")}else document.querySelector("#blocks").classList.remove("done")}function loadSamples(){fetch("./samples.txt",{method:"get"}).then(function(e){console.log("Response"),e.text().then(function(e){everything.value=e})}).catch(function(e){console.log("Error"),console.log(e)}),fetch("./clusters.txt",{method:"get"}).then(function(e){console.log("Response"),e.text().then(function(e){clusters.value=e})}).catch(function(e){console.log("Error"),console.log(e)})}var go=document.querySelector("#go"),inputtext=document.querySelector("#input"),download=document.querySelector("#download"),clusters=document.querySelector("#clusters"),uselocalmess=document.querySelector("#uselocalmess"),everything=document.querySelector("#everything"),exportclusters=document.querySelector("#exportclusters"),exporteverything=document.querySelector("#exporteverything"),exportlocal=document.querySelector("#exportlocal"),savegraph=document.querySelector("#savegraph"),exporteverythingfile=document.querySelector("#exporteverythingfile"),exportclustersfile=document.querySelector("#exportclustersfile"),exportlocalfile=document.querySelector("#exportlocalfile"),downloadfile=document.querySelector("#downloadfile"),graphfile=document.querySelector("#graphfile"),maketable=document.querySelector("#maketable"),blocklinks=document.querySelector("#block-links");saveState(inputtext,"input"),inputtext.addEventListener("blur",function(){exportlocal.setAttribute("href","data:application/octet-stream,"+encodeURIComponent(inputtext.value))}),saveState(clusters,"clusters"),clusters.addEventListener("blur",function(){exportclusters.setAttribute("href","data:application/octet-stream,"+encodeURIComponent(clusters.value))}),saveState(everything,"everything"),everything.addEventListener("blur",function(){exporteverything.setAttribute("href","data:application/octet-stream,"+encodeURIComponent(everything.value))}),"checked"==localStorage.getItem("uselocalmess")&&(uselocalmess.checked=!0),"unchecked"==localStorage.getItem("uselocalmess")&&(uselocalmess.checked=!1),uselocalmess.addEventListener("change",function(){this.checked?localStorage.setItem("uselocalmess","checked"):localStorage.setItem("uselocalmess","unchecked"),startProcess()}),saveState(exporteverythingfile,"exporteverythingfile"),exporteverything.innerHTML='<i class="fi-page-export"></i> Export '+exporteverythingfile.value+".txt",exporteverything.setAttribute("download",exporteverythingfile.value+".txt"),exporteverythingfile.addEventListener("change",function(){exporteverything.setAttribute("download",this.value+".txt"),exporteverything.innerHTML='<i class="fi-page-export"></i> Export '+this.value+".txt"}),saveState(exportclustersfile,"exportclustersfile"),exportclusters.innerHTML='<i class="fi-page-export"></i> Export '+exportclustersfile.value+".txt",exportclusters.setAttribute("download",exportclustersfile.value+".txt"),exportclustersfile.addEventListener("change",function(){exportclusters.setAttribute("download",this.value+".txt"),exportclusters.innerHTML='<i class="fi-page-export"></i> Export '+this.value+".txt"}),saveState(exportlocalfile,"exportlocalfile"),exportlocal.innerHTML='<i class="fi-page-export"></i> Export '+exportlocalfile.value+".txt",exportlocal.setAttribute("download",exportlocalfile.value+".txt"),exportlocalfile.addEventListener("change",function(){exportlocal.setAttribute("download",this.value+".txt"),exportlocal.innerHTML='<i class="fi-page-export"></i> Export '+this.value+".txt"}),saveState(downloadfile,"downloadfile"),downloadfile.addEventListener("change",function(){download.setAttribute("download",this.value+".csv"),download.innerHTML='<i class="fi-download"></i> Download '+this.value+".csv"}),saveState(graphfile,"graphfile"),savegraph.innerHTML='<i class="fi-download"></i> Download '+graphfile.value+".png",savegraph.setAttribute("download",graphfile.value+".png"),graphfile.addEventListener("change",function(){savegraph.setAttribute("download",this.value+".png"),savegraph.innerHTML='<i class="fi-download"></i> Download '+this.value+".png"}),exportclusters.setAttribute("href","data:application/octet-stream,"+encodeURIComponent(clusters.value)),exporteverything.setAttribute("href","data:application/octet-stream,"+encodeURIComponent(everything.value)),exportlocal.setAttribute("href","data:application/octet-stream,"+encodeURIComponent(inputtext.value));var bgWorker=new Worker("js/worker.js");bgWorker.onmessage=function(e){"processlocal"!=e.data[0]&&"processblocks"!=e.data[0]||(console.log("Process finished"),localStorage.setItem("result",e.data[1]),download.setAttribute("href",makeTextFile(e.data[1])),download.setAttribute("class","button success"),download.innerHTML='<i class="fi-download"></i> Download '+downloadfile.value+".csv",download.setAttribute("download",downloadfile.value+".csv"),document.querySelector("#charts").classList.add("done"),buildCharts(e.data[2]),updateBlocks()),"progress"==e.data[0]&&(download.setAttribute("class","button warning"),download.innerHTML='<i class="fi-clock"></i> '+e.data[1]+"% Complete"),e.data[0]},go.addEventListener("click",function(e){e.preventDefault(),startProcess()}),maketable&&maketable.addEventListener("click",function(e){e.preventDefault();var t=localStorage.getItem("result");if(!t)return void console.log("No results stored. Please Process first");bgWorker.postMessage(["maketable",t])}),document.querySelector(".load-samples").addEventListener("click",function(e){e.preventDefault(),loadSamples()});var tabs=document.querySelectorAll("#tabs a"),tabsContent=document.querySelectorAll(".tab-content");tabs&&tabs.forEach(function(e,t){e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").replace("#","");tabs.forEach(function(e){e.classList.remove("active")}),tabsContent.forEach(function(e){e.classList.remove("active")}),document.querySelector("#"+t).classList.add("active"),this.classList.add("active")})});